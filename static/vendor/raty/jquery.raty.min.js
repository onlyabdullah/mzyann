!function($){"use strict";var methods={init:function(options){return this.each(function(){this.self=$(this),methods.destroy.call(this.self),this.opt=$.extend(!0,{},$.fn.raty.defaults,options),methods._adjustCallback.call(this),methods._adjustNumber.call(this),methods._adjustHints.call(this),this.opt.score=methods._adjustedScore.call(this,this.opt.score),"img"!==this.opt.starType&&methods._adjustStarType.call(this),methods._adjustPath.call(this),methods._createStars.call(this),this.opt.cancel&&methods._createCancel.call(this),this.opt.precision&&methods._adjustPrecision.call(this),methods._createScore.call(this),methods._apply.call(this,this.opt.score),methods._setTitle.call(this,this.opt.score),methods._target.call(this,this.opt.score),this.opt.readOnly?methods._lock.call(this):(this.style.cursor="pointer",methods._binds.call(this))})},_adjustCallback:function(){for(var options=["number","readOnly","score","scoreName","target","path"],i=0;i<options.length;i++)"function"==typeof this.opt[options[i]]&&(this.opt[options[i]]=this.opt[options[i]].call(this))},_adjustedScore:function(score){return score?methods._between(score,0,this.opt.number):score},_adjustHints:function(){if(this.opt.hints||(this.opt.hints=[]),this.opt.halfShow||this.opt.half)for(var steps=this.opt.precision?10:2,i=0;i<this.opt.number;i++){var group=this.opt.hints[i];"[object Array]"!==Object.prototype.toString.call(group)&&(group=[group]),this.opt.hints[i]=[];for(var j=0;j<steps;j++){var hint=group[j],last=group[group.length-1];void 0===last&&(last=null),this.opt.hints[i][j]=void 0===hint?last:hint}}},_adjustNumber:function(){this.opt.number=methods._between(this.opt.number,1,this.opt.numberMax)},_adjustPath:function(){this.opt.path=this.opt.path||"",this.opt.path&&"/"!==this.opt.path.charAt(this.opt.path.length-1)&&(this.opt.path+="/")},_adjustPrecision:function(){this.opt.half=!0},_adjustStarType:function(){var replaces=["cancelOff","cancelOn","starHalf","starOff","starOn"];this.opt.path="";for(var i=0;i<replaces.length;i++)this.opt[replaces[i]]=this.opt[replaces[i]].replace(".","-")},_apply:function(score){methods._fill.call(this,score),score&&(score>0&&this.score.val(score),methods._roundStars.call(this,score))},_between:function(value,min,max){return Math.min(Math.max(parseFloat(value),min),max)},_binds:function(){this.cancel&&(methods._bindOverCancel.call(this),methods._bindClickCancel.call(this),methods._bindOutCancel.call(this)),methods._bindOver.call(this),methods._bindClick.call(this),methods._bindOut.call(this)},_bindClick:function(){var that=this;that.stars.on("click.raty",function(evt){var execute=!0,score=that.opt.half||that.opt.precision?that.self.data("score"):this.alt||$(this).data("alt");that.opt.click&&(execute=that.opt.click.call(that,+score,evt)),(execute||void 0===execute)&&(that.opt.half&&!that.opt.precision&&(score=methods._roundHalfScore.call(that,score)),methods._apply.call(that,score))})},_bindClickCancel:function(){var that=this;that.cancel.on("click.raty",function(evt){that.score.removeAttr("value"),that.opt.click&&that.opt.click.call(that,null,evt)})},_bindOut:function(){var that=this;that.self.on("mouseleave.raty",function(evt){var score=+that.score.val()||void 0;methods._apply.call(that,score),methods._target.call(that,score,evt),methods._resetTitle.call(that),that.opt.mouseout&&that.opt.mouseout.call(that,score,evt)})},_bindOutCancel:function(){var that=this;that.cancel.on("mouseleave.raty",function(evt){var icon=that.opt.cancelOff;if("img"!==that.opt.starType&&(icon=that.opt.cancelClass+" "+icon),methods._setIcon.call(that,this,icon),that.opt.mouseout){var score=+that.score.val()||void 0;that.opt.mouseout.call(that,score,evt)}})},_bindOver:function(){var that=this,action=that.opt.half?"mousemove.raty":"mouseover.raty";that.stars.on(action,function(evt){var score=methods._getScoreByPosition.call(that,evt,this);methods._fill.call(that,score),that.opt.half&&(methods._roundStars.call(that,score,evt),methods._setTitle.call(that,score,evt),that.self.data("score",score)),methods._target.call(that,score,evt),that.opt.mouseover&&that.opt.mouseover.call(that,score,evt)})},_bindOverCancel:function(){var that=this;that.cancel.on("mouseover.raty",function(evt){var starOff=that.opt.path+that.opt.starOff,icon=that.opt.cancelOn;"img"===that.opt.starType?that.stars.attr("src",starOff):(icon=that.opt.cancelClass+" "+icon,that.stars.attr("class",starOff)),methods._setIcon.call(that,this,icon),methods._target.call(that,null,evt),that.opt.mouseover&&that.opt.mouseover.call(that,null)})},_buildScoreField:function(){return $("<input />",{name:this.opt.scoreName,type:"hidden"}).appendTo(this)},_createCancel:function(){var icon=this.opt.path+this.opt.cancelOff,cancel=$("<"+this.opt.starType+" />",{title:this.opt.cancelHint,class:this.opt.cancelClass});"img"===this.opt.starType?cancel.attr({src:icon,alt:"x"}):cancel.attr("data-alt","x").addClass(icon),"left"===this.opt.cancelPlace?this.self.prepend("&#160;").prepend(cancel):this.self.append("&#160;").append(cancel),this.cancel=cancel},_createScore:function(){var score=$(this.opt.targetScore);this.score=score.length?score:methods._buildScoreField.call(this)},_createStars:function(){for(var i=1;i<=this.opt.number;i++){var name=methods._nameForIndex.call(this,i),attrs={alt:i,src:this.opt.path+this.opt[name]};"img"!==this.opt.starType&&(attrs={"data-alt":i,class:attrs.src}),attrs.title=methods._getHint.call(this,i),$("<"+this.opt.starType+" />",attrs).appendTo(this),this.opt.space&&this.self.append(i<this.opt.number?"&#160;":"")}this.stars=this.self.children(this.opt.starType)},_error:function(message){$(this).text(message),$.error(message)},_fill:function(score){for(var hash=0,i=1;i<=this.stars.length;i++){var icon,star=this.stars[i-1],turnOn=methods._turnOn.call(this,i,score);if(this.opt.iconRange&&this.opt.iconRange.length>hash){var irange=this.opt.iconRange[hash];icon=methods._getRangeIcon.call(this,irange,turnOn),i<=irange.range&&methods._setIcon.call(this,star,icon),i===irange.range&&hash++}else icon=this.opt[turnOn?"starOn":"starOff"],methods._setIcon.call(this,star,icon)}},_getFirstDecimal:function(number){var decimal=number.toString().split(".")[1],result=0;return decimal&&(result=parseInt(decimal.charAt(0),10),"9999"===decimal.slice(1,5)&&result++),result},_getRangeIcon:function(irange,turnOn){return turnOn?irange.on||this.opt.starOn:irange.off||this.opt.starOff},_getScoreByPosition:function(evt,icon){var score=parseInt(icon.alt||icon.getAttribute("data-alt"),10);if(this.opt.half){var size=methods._getWidth.call(this),percent;score=score-1+parseFloat((evt.pageX-$(icon).offset().left)/size)}return score},_getHint:function(score,evt){if(0!==score&&!score)return this.opt.noRatedMsg;var decimal=methods._getFirstDecimal.call(this,score),integer=Math.ceil(score),group=this.opt.hints[(integer||1)-1],hint=group,set=!evt||this.move;return this.opt.precision?(set&&(decimal=0===decimal?9:decimal-1),hint=group[decimal]):(this.opt.halfShow||this.opt.half)&&(hint=group[decimal=set&&0===decimal?1:decimal>5?1:0]),""===hint?"":hint||score},_getWidth:function(){var width=this.stars[0].width||parseFloat(this.stars.eq(0).css("font-size"));return width||methods._error.call(this,"Could not get the icon width!"),width},_lock:function(){var hint=methods._getHint.call(this,this.score.val());this.style.cursor="",this.title=hint,this.score.prop("readonly",!0),this.stars.prop("title",hint),this.cancel&&this.cancel.hide(),this.self.data("readonly",!0)},_nameForIndex:function(i){return this.opt.score&&this.opt.score>=i?"starOn":"starOff"},_resetTitle:function(star){for(var i=0;i<this.opt.number;i++)this.stars[i].title=methods._getHint.call(this,i+1)},_roundHalfScore:function(score){var integer=parseInt(score,10),decimal=methods._getFirstDecimal.call(this,score);return 0!==decimal&&(decimal=decimal>5?1:.5),integer+decimal},_roundStars:function(score,evt){var decimal=(score%1).toFixed(2),name;if(evt||this.move?name=decimal>.5?"starOn":"starHalf":decimal>this.opt.round.down&&(name="starOn",this.opt.halfShow&&decimal<this.opt.round.up?name="starHalf":decimal<this.opt.round.full&&(name="starOff")),name){var icon=this.opt[name],star=this.stars[Math.ceil(score)-1];methods._setIcon.call(this,star,icon)}},_setIcon:function(star,icon){star["img"===this.opt.starType?"src":"className"]=this.opt.path+icon},_setTarget:function(target,score){score&&(score=this.opt.targetFormat.toString().replace("{score}",score)),target.is(":input")?target.val(score):target.html(score)},_setTitle:function(score,evt){if(score){var integer=parseInt(Math.ceil(score),10),star;this.stars[integer-1].title=methods._getHint.call(this,score,evt)}},_target:function(score,evt){if(this.opt.target){var target=$(this.opt.target);target.length||methods._error.call(this,"Target selector invalid or missing!");var mouseover=evt&&"mouseover"===evt.type;if(void 0===score)score=this.opt.targetText;else if(null===score)score=mouseover?this.opt.cancelHint:this.opt.targetText;else{"hint"===this.opt.targetType?score=methods._getHint.call(this,score,evt):this.opt.precision&&(score=parseFloat(score).toFixed(1));var mousemove=evt&&"mousemove"===evt.type;mouseover||mousemove||this.opt.targetKeep||(score=this.opt.targetText)}methods._setTarget.call(this,target,score)}},_turnOn:function(i,score){return this.opt.single?i===score:i<=score},_unlock:function(){this.style.cursor="pointer",this.removeAttribute("title"),this.score.removeAttr("readonly"),this.self.data("readonly",!1);for(var i=0;i<this.opt.number;i++)this.stars[i].title=methods._getHint.call(this,i+1);this.cancel&&this.cancel.css("display","")},cancel:function(click){return this.each(function(){var self=$(this);!0!==self.data("readonly")&&(methods[click?"click":"score"].call(self,null),this.score.removeAttr("value"))})},click:function(score){return this.each(function(){!0!==$(this).data("readonly")&&(score=methods._adjustedScore.call(this,score),methods._apply.call(this,score),this.opt.click&&this.opt.click.call(this,score,$.Event("click")),methods._target.call(this,score))})},destroy:function(){return this.each(function(){var self=$(this),raw=self.data("raw");raw?self.off(".raty").empty().css({cursor:raw.style.cursor}).removeData("readonly"):self.data("raw",self.clone()[0])})},getScore:function(){var score=[],value;return this.each(function(){value=this.score.val(),score.push(value?+value:void 0)}),score.length>1?score:score[0]},move:function(score){return this.each(function(){var integer=parseInt(score,10),decimal=methods._getFirstDecimal.call(this,score);integer>=this.opt.number&&(integer=this.opt.number-1,decimal=10);var width,steps=methods._getWidth.call(this)/10,star=$(this.stars[integer]),percent=star.offset().left+steps*decimal,evt=$.Event("mousemove",{pageX:percent});this.move=!0,star.trigger(evt),this.move=!1})},readOnly:function(readonly){return this.each(function(){var self=$(this);self.data("readonly")!==readonly&&(readonly?(self.off(".raty").children(this.opt.starType).off(".raty"),methods._lock.call(this)):(methods._binds.call(this),methods._unlock.call(this)),self.data("readonly",readonly))})},reload:function(){return methods.set.call(this,{})},score:function(){var self=$(this);return arguments.length?methods.setScore.apply(self,arguments):methods.getScore.call(self)},set:function(options){return this.each(function(){$(this).raty($.extend({},this.opt,options))})},setScore:function(score){return this.each(function(){!0!==$(this).data("readonly")&&(score=methods._adjustedScore.call(this,score),methods._apply.call(this,score),methods._target.call(this,score))})}};$.fn.raty=function(method){return methods[method]?methods[method].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof method&&method?void $.error("Method "+method+" does not exist!"):methods.init.apply(this,arguments)},$.fn.raty.defaults={cancel:!1,cancelClass:"raty-cancel",cancelHint:"Cancel this rating!",cancelOff:"cancel-off.png",cancelOn:"cancel-on.png",cancelPlace:"left",click:void 0,half:!1,halfShow:!0,hints:["bad","poor","regular","good","gorgeous"],iconRange:void 0,mouseout:void 0,mouseover:void 0,noRatedMsg:"Not rated yet!",number:5,numberMax:20,path:void 0,precision:!1,readOnly:!1,round:{down:.25,full:.6,up:.76},score:void 0,scoreName:"score",single:!1,space:!0,starHalf:"star-half.png",starOff:"star-off.png",starOn:"star-on.png",starType:"img",target:void 0,targetFormat:"{score}",targetKeep:!1,targetScore:void 0,targetText:"",targetType:"hint"}}(jQuery);